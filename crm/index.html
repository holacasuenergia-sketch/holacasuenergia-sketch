<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM - Enerlux Soluciones</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f8fafc;
    }
    .container { 
      display: flex; justify-content: center; align-items: center; 
      min-height: 100vh; 
      background: linear-gradient(135deg, #0b4f8a 0%, #0a3b6f 100%);
      padding: 20px;
    }
    .login-card { 
      background: white; 
      padding: 48px; 
      border-radius: 24px; 
      width: 100%; 
      max-width: 420px; 
      box-shadow: 0 25px 50px rgba(0,0,0,0.15); 
    }
    .login-card h2 { 
      color: #0a3b6f; 
      text-align: center; 
      margin-bottom: 32px;
      font-size: 28px;
      font-weight: 700;
    }
    .login-card label {
      display: block;
      margin: 24px 0 8px;
      font-weight: 600;
      color: #334155;
      font-size: 14px;
    }
    .login-card input, .login-card select, .login-card textarea { 
      width: 100%; 
      padding: 14px 16px; 
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      box-sizing: border-box; 
      font-size: 15px;
      transition: border-color 0.2s;
    }
    .login-card input:focus, .login-card select:focus, .login-card textarea:focus {
      outline: none;
      border-color: #0a3b6f;
    }
    .login-card button { 
      width: 100%; 
      padding: 14px 20px; 
      background: linear-gradient(135deg, #0a3b6f 0%, #0b4f8a 100%);
      color: white; 
      border: none; 
      border-radius: 12px; 
      margin-top: 24px; 
      font-size: 16px; 
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 12px rgba(10, 59, 111, 0.3);
    }
    .login-card button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(10, 59, 111, 0.4);
    }
    .login-card button:active {
      transform: translateY(0);
    }
    .login-card button:disabled { 
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .login-card button.secondary { 
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      margin-top: 12px;
      box-shadow: 0 4px 12px rgba(71, 85, 105, 0.3);
    }
    .login-card button.secondary:hover {
      box-shadow: 0 6px 16px rgba(71, 85, 105, 0.4);
    }
    .login-card button.danger { 
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .login-card button.danger:hover {
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }
    .login-card button.success { 
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }
    .login-card button.success:hover {
      box-shadow: 0 6px 16px rgba(34, 197, 94, 0.4);
    }
    .error { 
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }
    .info { 
      text-align: center; 
      margin: 24px 0 0;
      color: #64748b;
      font-size: 13px;
    }
    .info ul { 
      color: #94a3b8;
      margin: 8px 0 0 0;
      padding: 0;
      list-style: none;
      font-size: 12px;
    }
    .info li { margin: 6px 0; }
    .dashboard { display: none; background: #f8fafc; min-height: 100vh; }
    .header { 
      background: linear-gradient(135deg, #0a3b6f 0%, #0b4f8a 100%);
      color: white; 
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .header h1 {
      font-size: 24px;
      font-weight: 700;
    }
    .header p {
      margin: 4px 0 0;
      font-size: 14px;
      opacity: 0.9;
    }
    .content { padding: 32px 40px; max-width: 1600px; margin: 0 auto; }
    
    /* Modern Stats Grid */
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
      gap: 20px; 
      margin-bottom: 32px;
    }
    .stat-card { 
      background: white; 
      border-radius: 16px; 
      padding: 28px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }
    .stat-card h3 { 
      color: #64748b; 
      font-size: 13px; 
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    .stat-card .value { 
      font-size: 36px; 
      font-weight: 800;
      color: #0a3b6f;
      margin-bottom: 4px;
    }
    .stat-card .sub { 
      font-size: 13px; 
      color: #64748b;
    }
    .stat-card.highlight {
      border-left: 4px solid #22c55e;
    }
    
    /* Welcome Card */
    .welcome-card { 
      background: white;
      border-radius: 16px; 
      padding: 32px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
      margin-bottom: 32px;
    }
    .welcome-card h3 {
      color: #0a3b6f;
      font-size: 22px;
      font-weight: 700;
      margin: 0 0 16px;
    }
    
    /* Logout Button */
    .logout { 
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      color: white; 
      border: 1px solid rgba(255,255,255,0.3); 
      padding: 10px 20px; 
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    .logout:hover {
      background: rgba(255,255,255,0.25);
    }
    
    /* Loading */
    .loading { 
      text-align: center; 
      color: #0a3b6f; 
      background: #f8fafc;
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 18px;
      font-weight: 500;
    }
    
    /* Modal */
    .modal { 
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
    }
    .modal-content { 
      background-color: white; 
      margin: 4% auto; 
      padding: 40px;
      border-radius: 24px;
      width: 90%; 
      max-width: 520px; 
      box-shadow: 0 25px 60px rgba(0,0,0,0.3);
    }
    .modal-content h2 {
      color: #0a3b6f;
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 28px;
    }
    .close { 
      color: #94a3b8; 
      float: right; 
      font-size: 32px; 
      font-weight: bold; 
      cursor: pointer;
      transition: color 0.2s;
    }
    .close:hover { color: #475569; }
    
    /* Progress Bar */
    .progress-container {
      background: #f1f5f9;
      border-radius: 10px;
      height: 28px;
      margin: 12px 0;
      overflow: hidden;
      position: relative;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
      border-radius: 10px;
      transition: width 0.6s ease;
      position: relative;
    }
    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Modern Table */
    .operations-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
    }
    .operations-table thead {
      background: linear-gradient(135deg, #0a3b6f 0%, #0b4f8a 100%);
      color: white;
    }
    .operations-table th, .operations-table td { 
      padding: 16px 20px; 
      text-align: left; 
      border-bottom: 1px solid #e2e8f0;
    }
    .operations-table th {
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .operations-table tr:last-child td {
      border-bottom: none;
    }
    .operations-table tbody tr:hover {
      background: #f8fafc;
      transition: background 0.2s;
    }
    .operations-table .client-name {
      font-weight: 600;
      color: #0a3b6f;
    }
    
    /* Status Badges */
    .status-badge { 
      display: inline-block;
      padding: 6px 14px; 
      border-radius: 20px; 
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .status-tramite { 
      background: #fef3c7; 
      color: #92400e;
    }
    .status-completo { 
      background: #dbeafe; 
      color: #1e40af;
    }
    .status-activo { 
      background: #dcfce7; 
      color: #166534;
    }
    .status-baja { 
      background: #fee2e2; 
      color: #991b1b;
    }
    
    /* Action Buttons */
    .action-buttons { 
      display: flex; 
      gap: 8px;
    }
    .action-buttons button { 
      width: auto; 
      padding: 8px 14px; 
      margin: 0; 
      font-size: 13px;
      border-radius: 8px;
    }
    
    /* Leaderboard */
    .leaderboard { 
      background: white;
      border-radius: 16px; 
      padding: 32px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
    }
    .leaderboard h3 {
      color: #0a3b6f;
      font-size: 22px;
      font-weight: 700;
      margin: 0 0 24px;
    }
    .leaderboard-item { 
      display: flex; 
      align-items: center; 
      padding: 16px 0; 
      border-bottom: 1px solid #e2e8f0;
      transition: background 0.2s;
    }
    .leaderboard-item:last-child { border-bottom: none; }
    .rank { 
      width: 56px; 
      text-align: center;
      font-size: 28px; 
      font-weight: 800;
    }
    .rank-1 { color: #f59e0b; }
    .rank-2 { color: #94a3b8; }
    .rank-3 { color: #64748b; }
    .rank-other { color: #94a3b8; }
    .asesor-info { 
      flex: 1;
      padding: 0 16px;
    }
    .asesor-name { 
      font-weight: 700;
      font-size: 16px;
      color: #0a3b6f;
      margin-bottom: 4px;
    }
    .asesor-stats { 
      font-size: 14px; 
      color: #64748b;
    }
    .asesor-commission { 
      font-size: 24px; 
      font-weight: 800;
      color: #22c55e;
      text-align: right;
    }
    
    /* Tab Buttons */
    .tab-buttons { 
      display: flex; 
      gap: 12px; 
      margin-bottom: 28px; 
      flex-wrap: wrap;
    }
    .tab-button { 
      flex: 1; 
      min-width: 160px;
      padding: 14px 20px; 
      background: #f1f5f9;
      color: #64748b;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin: 0;
    }
    .tab-button.active { 
      background: linear-gradient(135deg, #0a3b6f 0%, #0b4f8a 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(10, 59, 111, 0.3);
    }
    .tab-button:hover:not(.active) {
      background: #e2e8f0;
    }
    .section { display: none; }
    .section.active { display: block; }
    
    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar button {
      width: auto;
      padding: 12px 20px;
      margin: 0;
      font-size: 15px;
      border-radius: 10px;
    }
    .filter-bar select {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 15px;
      background: white;
      cursor: pointer;
    }
    .filter-bar select:focus {
      outline: none;
      border-color: #0a3b6f;
    }
    
    /* Motivation Card */
    .motivation-card {
      background: linear-gradient(135deg, f8fafc 0%, f1f5f9 100%);
      border-radius: 16px;
      padding: 32px;
      border: 2px solid #e2e8f0;
      margin-top: 24px;
    }
    .motivation-card h4 {
      color: #64748b;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 12px;
    }
    .motivation-card p {
      font-size: 18px;
      color: #0a3b6f;
      font-weight: 600;
      line-height: 1.6;
    }
    
    /* Date Display */
    .date-display {
      text-align: center;
      margin-bottom: 28px;
      padding: 20px;
      background: linear-gradient(135deg, #0a3b6f 0%, #0b4f8a 100%);
      color: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(10, 59, 111, 0.2);
    }
    .date-display .day-name {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    .date-display .date-full {
      font-size: 16px;
      opacity: 0.9;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .header { 
        padding: 16px 20px;
        flex-direction: column;
        text-align: center;
        gap: 12px;
      }
      .content { padding: 20px; }
      .stats-grid { grid-template-columns: 1fr; }
      .operations-table-wrapper { overflow-x: auto; }
      .tab-buttons { flex-direction: column; }
      .tab-button { width: 100%; min-width: auto; }
      .filter-bar { flex-direction: column; }
      .filter-bar button { width: 100%; }
      .filter-bar select { width: 100%; }
      .login-card { padding: 28px; }
      .header h1 { font-size: 20px; }
      .stat-card .value { font-size: 28px; }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">‚ö° Cargando CRM...</div>

  <div id="login-screen" class="container" style="display: none;">
    <div class="login-card">
      <h2>Enerlux Soluciones</h2>
      <div id="login-error" class="error"></div>
      <form id="login-form">
        <label>Email</label>
        <input type="email" id="email" placeholder="admin@enerlux.com" required>
        <label>Contrase√±a</label>
        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        <button type="submit" id="login-btn">Iniciar sesi√≥n</button>
      </form>
      <div class="info">
        <p><strong>Credenciales de prueba:</strong></p>
        <ul>
          <li>Email: admin@enerlux.com</li>
          <li>Password: enerlux123</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="dashboard-screen" class="dashboard">
    <div class="header">
      <div>
        <h1>Enerlux Soluciones</h1>
        <p id="user-info">Asesor</p>
      </div>
      <button class="logout" onclick="logout()">Cerrar sesi√≥n</button>
    </div>
    <div class="content">
      <div class="date-display">
        <div class="day-name" id="day-name">Lunes</div>
        <div class="date-full" id="date-full">9 de febrero de 2026</div>
      </div>
      
      <h3 style="color: #0a3b6f; margin: 0 0 20px; font-size: 20px; font-weight: 700;">Dashboard</h3>
      
      <div class="tab-buttons" id="tab-buttons">
        <button class="tab-button active" onclick="switchTab('overview')">üìä Resumen</button>
        <button class="tab-button" onclick="switchTab('operations')">üìã Operaciones</button>
        <button class="tab-button" onclick="switchTab('objectives')">üéØ Objetivos</button>
        <button class="tab-button" onclick="switchTab('leaderboard')" id="leaderboard-tab" style="display: none;">üèÜ Ranking</button>
      </div>

      <!-- Overview Section -->
      <div id="overview-section" class="section active">
        <div class="stats-grid">
          <div class="stat-card highlight">
            <h3>üë• Ventas Hoy</h3>
            <div class="value" id="today-sales">0 / 2</div>
            <div class="sub">M√≠nimo: 2 ventas (L-V)</div>
          </div>
          <div class="stat-card highlight">
            <h3>üí∞ Ganancia Total</h3>
            <div class="value" id="total-commission">0‚Ç¨</div>
            <div class="sub">Todos los clientes activos</div>
          </div>
          <div class="stat-card">
            <h3>üìà Ventas Esta Semana</h3>
            <div class="value" id="weekly-sales">0 / 10</div>
            <div class="sub">Target semanal (L-V)</div>
          </div>
          <div class="stat-card">
            <h3>üèÜ Tasa de Conversi√≥n</h3>
            <div class="value" id="conversion-rate">0%</div>
            <div class="sub">Completos/Total</div>
          </div>
        </div>

        <div class="welcome-card">
          <h3>üéâ Bienvenido al CRM</h3>
          <p style="font-size: 16px; line-height: 1.7; color: #475569;" id="welcome-message"></p>
        </div>
      </div>

      <!-- Operations Section -->
      <div id="operations-section" class="section">
        <div class="filter-bar">
          <button class="success" onclick="openAddModal()">‚ûï Nueva Operaci√≥n</button>
          <select id="filter-status" onchange="filterOperations()">
            <option value="">Todos los estados</option>
            <option value="En tr√°mite">En tr√°mite</option>
            <option value="Completo">Completo</option>
            <option value="Activo">Activo</option>
            <option value="Dado de baja">Dado de baja</option>
          </select>
        </div>
        
        <div class="operations-table-wrapper">
          <table class="operations-table" id="operations-table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Estado</th>
                <th>Fecha Inicio</th>
                <th>Fecha Activo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="operations-tbody">
              <tr><td colspan="5" style="text-align: center; padding: 40px;">Cargando operaciones...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Objectives Section -->
      <div id="objectives-section" class="section">
        <div class="stats-grid">
          <div class="stat-card highlight">
            <h3>üì± Ventas de Hoy</h3>
            <div class="value" id="obj-today-sales">0 / 2</div>
            <div class="progress-container">
              <div class="progress-bar" id="progress-today-sales"></div>
            </div>
            <div class="sub">Objetivo: 2 ventas (70‚Ç¨ minimum)</div>
          </div>
          <div class="stat-card highlight">
            <h3>üìä Ventas de Esta Semana</h3>
            <div class="value" id="obj-weekly-sales">0 / 10</div>
            <div class="progress-container">
              <div class="progress-bar" id="progress-weekly-sales"></div>
            </div>
            <div class="sub">Target semanal (L-V)</div>
          </div>
          <div class="stat-card">
            <h3>üí∞ Clientes Activos Total</h3>
            <div class="value" id="obj-total-active">0</div>
            <div class="sub">Cartera total (35‚Ç¨/cliente)</div>
          </div>
          <div class="stat-card">
            <h3>üéØ Tasa de Conversi√≥n</h3>
            <div class="value" id="obj-conversion">0%</div>
            <div class="progress-container">
              <div class="progress-bar" id="progress-conversion"></div>
            </div>
            <div class="sub">Performance total</div>
          </div>
        </div>

        <div class="motivation-card">
          <h4>üí° Motivaci√≥n</h4>
          <p id="motivation-message">Cargando...</p>
        </div>
      </div>

      <!-- Leaderboard Section -->
      <div id="leaderboard-section" class="section">
        <div class="leaderboard" id="leaderboard-content">
          <h3>üèÜ Ranking de Asesores</h3>
          <div id="leaderboard-list">
            <p>Cargando ranking...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modal-title">Nueva Operaci√≥n</h2>
      <form id="operation-form">
        <label>Nombre del Cliente</label>
        <input type="text" id="client-name" required>
        
        <label>Estado</label>
        <select id="status" required>
          <option value="En tr√°mite">En tr√°mite</option>
          <option value="Completo">Completo</option>
          <option value="Activo">Activo</option>
          <option value="Dado de baja">Dado de baja</option>
        </select>

        <label>Fecha Inicio</label>
        <input type="date" id="date-inicio" required>

        <label>Fecha Completo</label>
        <input type="date" id="date-completo">

        <label>Fecha Activo</label>
        <input type="date" id="date-activo">

        <label>Fecha Baja</label>
        <input type="date" id="date-baja">

        <label>Notas</label>
        <textarea id="notes" placeholder="Detalles adicionales..." rows="3"></textarea>

        <button type="submit" id="save-btn">Guardar</button>
        <button type="button" class="secondary" onclick="closeModal()">Cancelar</button>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCC_j9qnWf0snHV7XOaFSQLiqszZzCkGuc",
      authDomain: "enerlux-crm.firebaseapp.com",
      projectId: "enerlux-crm",
      storageBucket: "enerlux-crm.firebasestorage.app",
      messagingSenderId: "84970919171",
      appId: "1:84970919171:web:a9904b377254bb26884536",
      measurementId: "G-LVY9D58L88"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Global variables
    let currentUser = null;
    let currentUserRole = null;
    let operations = [];
    let editingOperationId = null;

    // Constants
    const DAILY_TARGET = 2; // 2 ventas por d√≠a (L-V)
    const WEEKLY_TARGET = 10; // 10 ventas por semana (2 √ó 5 d√≠as)
    const COMMISSION_PER_CLIENT = 35; // 35‚Ç¨ por cliente activo

    // Elements
    const loading = document.getElementById('loading');
    const loginScreen = document.getElementById('login-screen');
    const dashboardScreen = document.getElementById('dashboard-screen');
    const loginForm = document.getElementById('login-form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');
    const modal = document.getElementById('modal');

    // Update date display
    function updateDateDisplay() {
      const now = new Date();
      const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
      const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
      
      document.getElementById('day-name').textContent = days[now.getDay()];
      document.getElementById('date-full').textContent = `${now.getDate()} de ${months[now.getMonth()]} de ${now.getFullYear()}`;
    }

    // Auth state listener
    auth.onAuthStateChanged(async (user) => {
      loading.style.display = 'none';
      
      if (user) {
        currentUser = user;
        await loadUserRole();
        loginScreen.style.display = 'none';
        dashboardScreen.style.display = 'block';
        updateDateDisplay();
        loadDashboard();
      } else {
        currentUser = null;
        currentUserRole = null;
        loginScreen.style.display = 'flex';
        dashboardScreen.style.display = 'none';
      }
    });

    // Load user role
    async function loadUserRole() {
      try {
        const snapshot = await db.ref(`users/${currentUser.uid}/role`).once('value');
        currentUserRole = snapshot.val() || 'asesor';
        console.log('User role:', currentUserRole);
        
        // Show leaderboard tab for admin only
        document.getElementById('leaderboard-tab').style.display = currentUserRole === 'admin' ? 'block' : 'none';
        
        updateUserInfo();
      } catch (error) {
        console.error('Error loading user role:', error);
        currentUserRole = 'asesor';
      }
    }

    // Update user info
    function updateUserInfo() {
      document.getElementById('user-info').textContent = currentUserRole === 'admin' ? 'Administrador' : 'Asesor';
      document.getElementById('welcome-message').textContent = currentUserRole === 'admin' 
        ? 'Accede al dashboard completo con todas las operaciones de los asesores.'
        : 'Tu dashboard personal para gestionar tus operaciones y alcanzar tus objetivos.';
    }

    // Load dashboard
    function loadDashboard() {
      loadOperations();
    }

    // Helper function: is same day
    function isSameDay(date1, date2) {
      return date1.getDate() === date2.getDate() &&
             date1.getMonth() === date2.getMonth() &&
             date1.getFullYear() === date2.getFullYear();
    }

    // Helper function: is same week
    function isSameWeek(date1, date2) {
      const oneDay = 24 * 60 * 60 * 1000;
      const diffDays = Math.floor(Math.abs(date1 - date2) / oneDay);
      
      // Get Monday of week for both dates
      const getMonday = (d) => {
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
      };
      
      const monday1 = getMonday(new Date(date1));
      const monday2 = getMonday(new Date(date2));
      
      return isSameDay(monday1, monday2);
    }

    // Load operations
    async function loadOperations() {
      try {
        let operationsRef;
        if (currentUserRole === 'admin') {
          operationsRef = db.ref('crms');
        } else {
          operationsRef = db.ref(`crms/${currentUser.uid}/operations`);
        }

        const snapshot = await operationsRef.once('value');
        operations = [];

        if (currentUserRole === 'admin') {
          snapshot.forEach((asesorSnapshot) => {
            const asesorOperations = asesorSnapshot.val();
            if (asesorOperations && asesorOperations.operations) {
              Object.keys(asesorOperations.operations).forEach((opId) => {
                operations.push({
                  id: opId,
                  asesorUid: asesorSnapshot.key,
                  ...asesorOperations.operations[opId]
                });
              });
            }
          });
        } else if (snapshot.val()) {
          if (snapshot.val().operations) {
            Object.keys(snapshot.val().operations).forEach((opId) => {
              operations.push({
                id: opId,
                ...snapshot.val().operations[opId]
              });
            });
          }
        }

        updateStats();
        updateOperationsTable();
        updateObjectives();
        updateLeaderboard();
      } catch (error) {
        console.error('Error loading operations:', error);
      }
    }

    // Update stats
    function updateStats() {
      const now = new Date();
      const activeClients = operations.filter(op => op.status === 'Activo').length;
      const totalCommission = activeClients * COMMISSION_PER_CLIENT;

      // Today's sales (L-V only)
      if (now.getDay() === 0 || now.getDay() === 6) {
        // Weekend - no sales counted
        document.getElementById('today-sales').textContent = 'Fin de semana';
        document.getElementById('weekly-sales').textContent = `${getWeekSales()} / ${WEEKLY_TARGET}`;
      } else {
        const todaySales = getTodaySales();
        document.getElementById('today-sales').textContent = `${todaySales} / ${DAILY_TARGET}`;
        document.getElementById('weekly-sales').textContent = `${getWeekSales()} / ${WEEKLY_TARGET}`;
      }

      // Monthly sales (simplified - use same as weekly for now)
      document.getElementById('total-commission').textContent = totalCommission + '‚Ç¨';
      document.getElementById('conversion-rate').textContent = calculateConversionRate() + '%';
      document.getElementById('obj-today-sales').textContent = now.getDay() === 0 || now.getDay() === 6 ? 'Fin de semana' : `${getTodaySales()} / ${DAILY_TARGET}`;
      document.getElementById('obj-weekly-sales').textContent = `${getWeekSales()} / ${WEEKLY_TARGET}`;
      document.getElementById('obj-total-active').textContent = activeClients;
      document.getElementById('obj-conversion').textContent = calculateConversionRate() + '%';

      // Update progress bars
      const todayProgress = (now.getDay() === 0 || now.getDay() === 6) ? 0 : Math.min((getTodaySales() / DAILY_TARGET) * 100, 100);
      const weekProgress = Math.min((getWeekSales() / WEEKLY_TARGET) * 100, 100);
      const conversionProgress = calculateConversionRate();

      document.getElementById('progress-today-sales').style.width = todayProgress + '%';
      document.getElementById('progress-weekly-sales').style.width = weekProgress + '%';
      document.getElementById('progress-conversion').style.width = conversionProgress + '%';

      // Update motivation message
      updateMotivation(todayProgress, weekProgress, conversionProgress);
    }

    // Get today's sales
    function getTodaySales() {
      const now = new Date();
      return operations.filter(op => {
        if (op.status !== 'Activo' || !op.dateActivo) return false;
        const date = new Date(op.dateActivo);
        return isSameDay(date, now);
      }).length;
    }

    // Get week's sales
    function getWeekSales() {
      const now = new Date();
      return operations.filter(op => {
        if (op.status !== 'Activo' || !op.dateActivo) return false;
        const date = new Date(op.dateActivo);
        return isSameWeek(date, now);
      }).length;
    }

    // Calculate conversion rate
    function calculateConversionRate() {
      const completedAndActive = operations.filter(op => op.status === 'Completo' || op.status === 'Activo').length;
      const conversionRate = operations.length > 0 ? Math.round((completedAndActive / operations.length) * 100) : 0;
      return conversionRate;
    }

    // Update motivation message
    function updateMotivation(todayProgress, weekProgress, conversionProgress) {
      const now = new Date();
      const isWeekday = now.getDay() >= 1 && now.getDay() <= 5;
      let message = '';

      if (now.getDay() === 0 || now.getDay() === 6) {
        message = 'üéÜ ¬°Fin de semana! Descansa y prep√°rate para una semana productiva.';
      } else if (todayProgress >= 100) {
        message = 'üåü ¬°Excelente! Has alcanzado tu objetivo diario. ¬°Sigue vendiendo para el bonus!';
      } else if (todayProgress >= 75) {
        message = 'üöÄ ¬°Casi llegas a las 2 ventas del d√≠a! ¬°Un √∫ltimo empuj√≥n!';
      } else if (weekProgress >= 100) {
        message = '‚ú® ¬°Semana incre√≠ble! Has superado tu objetivo semanal.';
      } else if (conversionProgress >= 70) {
        message = 'üí™ ¬°Buen trabajo! Tasa de conversi√≥n s√≥lida.';
      } else {
        message = 'üìà ¬°Cada venta cuenta! Apunta a las 2 ventas del d√≠a (70‚Ç¨ m√≠nimo). T√∫ puedes.';
      }
      document.getElementById('motivation-message').textContent = message;
    }

    // Update operations table
    function updateOperationsTable(filteredOperations = null) {
      const tbody = document.getElementById('operations-tbody');
      const ops = filteredOperations || operations;

      if (ops.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No hay operaciones registradas</td></tr>';
        return;
      }

      tbody.innerHTML = ops.map(op => {
        const statusClass = op.status === 'En tr√°mite' ? 'status-tramite' :
                           op.status === 'Completo' ? 'status-completo' :
                           op.status === 'Activo' ? 'status-activo' : 'status-baja';
        const statusLabel = op.status === 'Dado de baja' ? 'Baja' : op.status;

        return `
          <tr>
            <td><span class="client-name">${op.clientName}</span></td>
            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
            <td>${op.dateInicio || '-'}</td>
            <td>${op.dateActivo || '-'}</td>
            <td class="action-buttons">
              <button onclick="editOperation('${op.id}')">‚úèÔ∏è</button>
              <button class="danger" onclick="deleteOperation('${op.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Filter operations
    function filterOperations() {
      const statusFilter = document.getElementById('filter-status').value;
      if (!statusFilter) {
        updateOperationsTable();
        return;
      }
      const filtered = operations.filter(op => op.status === statusFilter);
      updateOperationsTable(filtered);
    }

    // Update objectives
    function updateObjectives() {
      // Already called in updateStats
    }

    // Update leaderboard
    async function updateLeaderboard() {
      if (currentUserRole !== 'admin') return;

      const content = document.getElementById('leaderboard-list');
      content.innerHTML = '<p>Cargando ranking...</p>';

      try {
        const asesoresSnapshot = await db.ref('users').once('value');
        const leaderboardData = [];

        await Promise.all(Object.keys(asesoresSnapshot.val() || {}).map(async (uid) => {
          const userRole = asesoresSnapshot.val()[uid]?.role;
          if (userRole !== 'asesor') return;

          const snapshot = await db.ref(`crms/${uid}/operations`).once('value');
          const asesorOperations = snapshot.val()?.operations || {};

          const operations = Object.keys(asesorOperations).map(opId => ({
            ...asesorOperations[opId]
          }));

          // Calculate this week's sales
          const now = new Date();
          const weekSales = operations.filter(op => {
            if (op.status !== 'Activo' || !op.dateActivo) return false;
            const date = new Date(op.dateActivo);
            return isSameWeek(date, now);
          }).length;

          const activeClients = operations.filter(op => op.status === 'Activo').length;
          const commission = activeClients * COMMISSION_PER_CLIENT;

          leaderboardData.push({
            uid,
            name: asesoresSnapshot.val()[uid]?.name || uid.substring(0, 8),
            activeClients,
            commission,
            weekSales
          });
        }));

        // Sort by commission (descending)
        leaderboardData.sort((a, b) => b.commission - a.commission);

        // Render leaderboard
        content.innerHTML = leaderboardData.map((asesor, index) => `
          <div class="leaderboard-item">
            <div class="rank rank-${index + 1}">${index + 1}</div>
            <div class="asesor-info">
              <div class="asesor-name">${asesor.name}</div>
              <div class="asesor-stats">${asesor.activeClients} clientes activos | ${asesor.weekSales} esta semana</div>
            </div>
            <div class="asesor-commission">${asesor.commission}‚Ç¨</div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading leaderboard:', error);
        content.innerHTML = '<p>Error al cargar ranking.</p>';
      }
    }

    // Open add modal
    function openAddModal() {
      editingOperationId = null;
      document.getElementById('modal-title').textContent = 'Nueva Operaci√≥n';
      document.getElementById('operation-form').reset();
      document.getElementById('date-inicio').valueAsDate = new Date();
      modal.style.display = 'block';
    }

    // Edit operation
    async function editOperation(opId) {
      const operation = operations.find(op => op.id === opId);
      if (!operation) return;

      editingOperationId = opId;
      document.getElementById('modal-title').textContent = 'Editar Operaci√≥n';
      document.getElementById('client-name').value = operation.clientName || '';
      document.getElementById('status').value = operation.status || 'En tr√°mite';
      document.getElementById('date-inicio').value = operation.dateInicio || '';
      document.getElementById('date-completo').value = operation.dateCompleto || '';
      document.getElementById('date-activo').value = operation.dateActivo || '';
      document.getElementById('date-baja').value = operation.dateBaja || '';
      document.getElementById('notes').value = operation.notes || '';
      modal.style.display = 'block';
    }

    // Delete operation
    async function deleteOperation(opId) {
      if (!confirm('¬øEst√°s seguro de eliminar esta operaci√≥n?')) return;

      try {
        await db.ref(`crms/${currentUser.uid}/operations/${opId}`).remove();
        alert('Operaci√≥n eliminada');
        loadOperations();
      } catch (error) {
        console.error('Error deleting operation:', error);
        alert('Error al eliminar operaci√≥n');
      }
    }

    // Close modal
    function closeModal() {
      modal.style.display = 'none';
      document.getElementById('operation-form').reset();
      editingOperationId = null;
    }

    // Save operation
    document.getElementById('operation-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const operationData = {
        clientName: document.getElementById('client-name').value.trim(),
        status: document.getElementById('status').value,
        dateInicio: document.getElementById('date-inicio').value,
        dateCompleto: document.getElementById('date-completo').value,
        dateActivo: document.getElementById('date-activo').value,
        dateBaja: document.getElementById('date-baja').value,
        notes: document.getElementById('notes').value,
        updatedAt: Date.now()
      };

      try {
        if (editingOperationId) {
          await db.ref(`crms/${currentUser.uid}/operations/${editingOperationId}`).update(operationData);
          alert('Operaci√≥n actualizada');
        } else {
          operationData.createdAt = Date.now();
          await db.ref(`crms/${currentUser.uid}/operations`).push(operationData);
          alert('Operaci√≥n creada');
        }
        closeModal();
        loadOperations();
      } catch (error) {
        console.error('Error saving operation:', error);
        alert('Error al guardar operaci√≥n');
      }
    });

    // Login form submit
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      
      if (!email || !password) {
        showError('Por favor, completa todos los campos');
        return;
      }
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'Cargando...';
      loginError.style.display = 'none';
      
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        console.log('Login successful:', userCredential.user.email);
      } catch (error) {
        console.error('Login error:', error);
        showError('Credenciales incorrectas: ' + error.message);
        loginBtn.disabled = false;
        loginBtn.textContent = 'Iniciar sesi√≥n';
      }
    });

    // Logout function
    function logout() {
      auth.signOut().then(() => {
        console.log('Logout successful');
      }).catch((error) => {
        console.error('Logout error:', error);
      });
    }

    // Show error message
    function showError(message) {
      loginError.textContent = message;
      loginError.style.display = 'block';
    }

    // Switch tabs
    function switchTab(tabId) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Deactivate all buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      
      // Activate selected section
      document.getElementById(tabId + '-section').classList.add('active');
      
      // Activate button
      const buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(button => {
        if (button.getAttribute('onclick').includes(tabId)) {
          button.classList.add('active');
        }
      });

      // Reload leaderboard if switching to leaderboard
      if (tabId === 'leaderboard' && currentUserRole === 'admin') {
        updateLeaderboard();
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target === modal) {
        closeModal();
      }
    }
  </script>
</body>
</html>